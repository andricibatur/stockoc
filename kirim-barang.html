<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Track Pengiriman</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    textarea { width: 100%; height: 80px; margin-bottom: 1rem; }
    input, select, button { margin: 0.25rem 0; display: block; width: 100%; padding: 0.5rem; }
    
    /* Grid container untuk node */
    .nodes-grid {
      display: grid;
      grid-template-columns: repeat(14, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 1rem;
    }
    
    .node {
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      text-align: center;
      background: #ccffcc;
      box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
      transition: all 0.3s;
      min-height: 60px;
      word-break: break-word;
      overflow: hidden;
    }
    
    .node select {
      width: 100%;
      font-size: 0.6rem;
      margin-top: 4px;
      padding: 2px;
    }
    
    .blink-yellow { animation: blinkYellow 1s infinite; }
    .blink-red { animation: blinkRed 1s infinite; }
    @keyframes blinkYellow {
      0%, 100% { background-color: #ccffcc; }
      50% { background-color: #ffff99; }
    }
    @keyframes blinkRed {
      0%, 100% { background-color: #ccffcc; }
      50% { background-color: #ff9999; }
    }
    
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background: #eee; }
    .hapus { color: red; cursor: pointer; }
  </style>
</head>
<body>
  <h3>Form Pengiriman</h3>
  <textarea id="catatan" placeholder="Catatan pengiriman..."></textarea>
  <input id="id" placeholder="No ID Pengiriman">
  <input id="penerima" placeholder="Nama Penerima">
  <input id="cs" placeholder="Nama CS">
  <select id="ecom">
    <option value="">Pilih Ecom</option>
    <option>Shopee</option>
    <option>Lazada</option>
    <option>Tokopedia</option>
    <option>TikTok</option>
    <option>Lainnya</option>
  </select>
  <select id="kurir">
    <option value="">Pilih Kurir</option>
    <option>JNE</option>
    <option>J&T</option>
    <option>SPX</option>
    <option>LEX</option>
  </select>
  <select id="status">
    <option>Dikirim</option>
    <option>Berhasil</option>
    <option>Gagal</option>
    <option>Usut Tuntas</option>
  </select>
  <button onclick="tambahNode()">Tambah Node</button>

  <h3>Tracking Node</h3>
  <div id="nodes" class="nodes-grid"></div>

  <input id="cekId" placeholder="Masukkan ID untuk verifikasi" oninput="cekNodeId()">

  <h3>Filter Laporan</h3>
  <input id="filterLaporan" placeholder="Cari nama/ID..." oninput="renderNode()">

  <h3>Laporan Berhasil</h3>
  <table>
    <thead>
      <tr>
        <th>ID</th><th>Penerima</th><th>CS</th><th>Ecom</th><th>Kurir</th><th>Status</th><th>Waktu</th><th>Catatan</th><th>Hapus</th>
      </tr>
    </thead>
    <tbody id="laporan"></tbody>
  </table>

  <button onclick="exportData()">Export JSON</button>
  <button onclick="exportCSV()">Export CSV</button>
  <input type="file" accept="application/json" onchange="importData(event)">

  <script>
    let db, data = []

    const openDB = indexedDB.open("track_pengiriman", 1)
    openDB.onupgradeneeded = () => openDB.result.createObjectStore("data", { keyPath: "id" })
    openDB.onsuccess = () => {
      db = openDB.result
      muat()
    }

    function tambahNode() {
      const id = document.getElementById("id").value.trim()
      if (!id) return

      const obj = {
        id,
        penerima: document.getElementById("penerima").value,
        cs: document.getElementById("cs").value,
        ecom: document.getElementById("ecom").value,
        kurir: document.getElementById("kurir").value,
        status: document.getElementById("status").value,
        waktu: new Date().toISOString(),
        catatan: document.getElementById("catatan").value
      }
      const tx = db.transaction("data", "readwrite")
      tx.objectStore("data").put(obj)
      tx.oncomplete = () => {
        kosongkanForm()
        muat()
      }
    }

    function kosongkanForm() {
      ["id","penerima","cs","ecom","kurir","status","catatan"].forEach(id => document.getElementById(id).value = '')
    }

    function muat() {
      const tx = db.transaction("data", "readonly")
      const req = tx.objectStore("data").getAll()
      req.onsuccess = () => {
        data = req.result
        renderNode()
      }
    }

    function renderNode() {
      const now = new Date()
      const nodesDiv = document.getElementById("nodes")
      const laporanBody = document.getElementById("laporan")
      const filter = document.getElementById("filterLaporan").value.toLowerCase()
      nodesDiv.innerHTML = ''
      laporanBody.innerHTML = ''

      // Urutkan data berdasarkan status (yang bukan Berhasil di depan)
      const sortedData = [...data].sort((a, b) => {
        if (a.status === 'Berhasil' && b.status !== 'Berhasil') return 1
        if (a.status !== 'Berhasil' && b.status === 'Berhasil') return -1
        return 0
      })

      sortedData.forEach(item => {
        const umur = Math.floor((now - new Date(item.waktu)) / (1000 * 60 * 60 * 24))
        if (item.status === 'Berhasil') {
          if (
            item.id.toLowerCase().includes(filter) ||
            item.penerima.toLowerCase().includes(filter)
          ) {
            const row = document.createElement('tr')
            row.innerHTML = `
              <td>${item.id}</td>
              <td>${item.penerima}</td>
              <td>${item.cs}</td>
              <td>${item.ecom}</td>
              <td>${item.kurir}</td>
              <td>${item.status}</td>
              <td>${new Date(item.waktu).toLocaleString()}</td>
              <td>${item.catatan}</td>
              <td><span class="hapus" onclick="hapus('${item.id}')">Hapus</span></td>
            `
            laporanBody.appendChild(row)
          }
        } else {
          const div = document.createElement("div")
          div.className = "node"
          div.innerHTML = `
            <div style="font-weight:bold;">${item.id}</div>
            <div style="font-size:0.6rem;margin:2px 0;">${item.status}</div>
          `

          if (umur > 21) div.classList.add("blink-red")
          else if (umur > 15) div.classList.add("blink-yellow")

          const select = document.createElement("select")
          select.innerHTML = `
            <option ${item.status==='Dikirim'?'selected':''}>Dikirim</option>
            <option ${item.status==='Berhasil'?'selected':''}>Berhasil</option>
            <option ${item.status==='Gagal'?'selected':''}>Gagal</option>
            <option ${item.status==='Usut Tuntas'?'selected':''}>Usut Tuntas</option>
            <option ${item.status==='Kembali'?'selected':''}>Kembali</option>
          `
          select.onchange = () => {
            item.status = select.value
            const tx = db.transaction("data", "readwrite")
            tx.objectStore("data").put(item)
            tx.oncomplete = muat
          }
          div.appendChild(select)
          nodesDiv.appendChild(div)
        }
      })
    }

    function cekNodeId() {
      const val = document.getElementById("cekId").value.trim()
      const tx = db.transaction("data", "readwrite")
      const store = tx.objectStore("data")
      const req = store.get(val)
      req.onsuccess = () => {
        const obj = req.result
        if (obj) {
          obj.status = 'Berhasil'
          store.put(obj)
          tx.oncomplete = muat
        }
      }
    }

    function hapus(id) {
      if (!confirm('Yakin ingin menghapus data ini?')) return
      const tx = db.transaction("data", "readwrite")
      tx.objectStore("data").delete(id)
      tx.oncomplete = muat
    }

    function exportData() {
      const a = document.createElement('a')
      a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type: 'application/json'}))
      a.download = 'track_pengiriman.json'
      a.click()
    }

    function exportCSV() {
      const rows = [
        ["ID","Penerima","CS","Ecomerce","Kurir","Status","Waktu","Catatan"]
      ]
      data.forEach(d => {
        if (d.status === 'Berhasil') {
          rows.push([d.id, d.penerima, d.cs, d.ecom, d.kurir, d.status, new Date(d.waktu).toLocaleString(), d.catatan])
        }
      })
      const csvContent = rows.map(e => e.map(v => `"${v}"`).join(",")).join("\n")
      const a = document.createElement("a")
      a.href = URL.createObjectURL(new Blob([csvContent], {type: "text/csv"}))
      a.download = "laporan_pengiriman.csv"
      a.click()
    }

    function importData(event) {
      const file = event.target.files[0]
      if (!file) return
      const reader = new FileReader()
      reader.onload = () => {
        try {
          const arr = JSON.parse(reader.result)
          if (!Array.isArray(arr)) throw new Error("Format data tidak valid")
          
          if (!confirm(`Anda akan mengimpor ${arr.length} data. Lanjutkan?`)) return
          
          const tx = db.transaction("data", "readwrite")
          const store = tx.objectStore("data")
          arr.forEach(item => store.put(item))
          tx.oncomplete = () => {
            alert(`Data berhasil diimpor (${arr.length} item)`)
            muat()
          }
        } catch (e) {
          alert("Gagal memuat data: " + e.message)
        }
      }
      reader.readAsText(file)
    }
  </script>
</body>
</html>
