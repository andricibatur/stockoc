<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Scanner Barcode Cepat</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
      max-width: 600px;
      margin: 0 auto;
    }
    #scanner-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 0 auto 15px;
    }
    #video {
      width: 100%;
      height: 300px;
      border: 2px solid #ddd;
      background: #000;
    }
    #scan-region {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 100px;
      border: 3px dashed rgba(0, 255, 0, 0.5);
      pointer-events: none;
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-bottom: 15px;
    }
    button {
      padding: 10px 15px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    button:hover {
      background: #45a049;
    }
    button#btnTorch {
      background: #FF9800;
    }
    button#btnTorch:hover {
      background: #e68a00;
    }
    button#btnClear {
      background: #f44336;
    }
    button#btnClear:hover {
      background: #d32f2f;
    }
    #log {
      white-space: pre-wrap;
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      height: 150px;
      overflow-y: auto;
      border: 1px solid #ddd;
      font-family: monospace;
    }
    .timestamp {
      color: #666;
      font-size: 0.9em;
    }
  </style>
</head>
<body>

  <h2 style="text-align: center;">Scanner Barcode Cepat</h2>
  
  <div id="scanner-container">
    <video id="video"></video>
    <div id="scan-region"></div>
  </div>

  <div class="button-group">
    <button id="btnStart">Mulai Scan</button>
    <button id="btnStop">Stop Scan</button>
    <button id="btnTorch">Lampu</button>
    <button id="btnKirimWA">Kirim WA</button>
    <button id="btnCopy">Salin Laporan</button>
    <button id="btnClear">Hapus</button>
  </div>

  <h3>Laporan Scan:</h3>
  <div id="log"></div>

  <!-- Gunakan versi spesifik ZXing yang stabil -->
  <script src="https://unpkg.com/@zxing/library@0.19.1"></script>
  <script>
    const videoElement = document.getElementById('video');
    const logElement = document.getElementById('log');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnTorch = document.getElementById('btnTorch');
    const btnKirimWA = document.getElementById('btnKirimWA');
    const btnCopy = document.getElementById('btnCopy');
    const btnClear = document.getElementById('btnClear');
    
    let log = JSON.parse(localStorage.getItem('scanLog') || '[]');
    let codeReader;
    let torchEnabled = false;
    let isScanning = false;

    // Update log display
    function updateLog() {
      logElement.innerHTML = log.map(entry => 
        `<div><span class="timestamp">[${entry.time}]</span> ${entry.text}</div>`
      ).join('');
      localStorage.setItem('scanLog', JSON.stringify(log));
    }
    updateLog();

    // Beep sound
    function beep() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(1500, ctx.currentTime);
      osc.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.1);
    }

    // Initialize scanner
    async function startScanner() {
      if (isScanning) return;
      
      codeReader = new ZXing.BrowserMultiFormatReader();
      
      try {
        // Dapatkan daftar perangkat kamera
        const videoInputDevices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
        
        // Pilih perangkat kamera belakang jika tersedia
        let selectedDeviceId = null;
        for (const device of videoInputDevices) {
          if (device.label.toLowerCase().includes('back') || 
              device.label.toLowerCase().includes('rear')) {
            selectedDeviceId = device.deviceId;
            break;
          }
        }
        
        // Jika tidak ada kamera belakang, gunakan perangkat pertama
        if (!selectedDeviceId && videoInputDevices.length > 0) {
          selectedDeviceId = videoInputDevices[0].deviceId;
        }
        
        if (!selectedDeviceId) {
          throw new Error('Tidak ada perangkat kamera yang ditemukan');
        }
        
        // Mulai scanning
        await codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
          if (result) {
            beep();
            const timestamp = new Date().toLocaleTimeString();
            const text = `Scan: ${result.text}`;
            log.unshift({ time: timestamp, text });
            if (log.length > 50) log.pop(); // Batasi jumlah log
            updateLog();
          }
          if (err && !(err instanceof ZXing.NotFoundException)) {
            console.error(err);
          }
        });
        
        isScanning = true;
        btnStart.disabled = true;
        btnStop.disabled = false;
        console.log('Scanner started');
        
      } catch (error) {
        console.error('Error starting scanner:', error);
        alert('Gagal memulai scanner: ' + error.message);
      }
    }

    // Stop scanner
    function stopScanner() {
      if (!isScanning) return;
      
      codeReader.reset();
      isScanning = false;
      btnStart.disabled = false;
      btnStop.disabled = true;
      console.log('Scanner stopped');
      
      // Matikan lampu saat scanner dihentikan
      torchEnabled = false;
      btnTorch.textContent = 'Lampu';
    }

    // Toggle torch
    async function toggleTorch() {
      if (!isScanning) {
        alert('Mulai scanner terlebih dahulu');
        return;
      }
      
      try {
        torchEnabled = !torchEnabled;
        const constraints = {
          advanced: [{ torch: torchEnabled }]
        };
        
        // Untuk beberapa browser perlu mengatur ulang stream
        await codeReader.videoElement.srcObject.getVideoTracks()[0].applyConstraints(constraints);
        btnTorch.textContent = torchEnabled ? 'Matikan Lampu' : 'Nyalakan Lampu';
      } catch (error) {
        console.error('Error toggling torch:', error);
        alert('Perangkat tidak mendukung lampu/flash');
      }
    }

    // Kirim ke WhatsApp
    function kirimWA() {
      if (log.length === 0) {
        alert('Tidak ada data laporan untuk dikirim');
        return;
      }
      
      const text = log.map(entry => `[${entry.time}] ${entry.text}`).join('%0A');
      const phoneNumber = ''; // Isi dengan nomor WhatsApp tujuan
      const url = `https://wa.me/${phoneNumber}?text=${text}`;
      window.open(url, '_blank');
    }

    // Event listeners
    btnStart.addEventListener('click', startScanner);
    btnStop.addEventListener('click', stopScanner);
    btnTorch.addEventListener('click', toggleTorch);
    btnKirimWA.addEventListener('click', kirimWA);
    
    btnCopy.addEventListener('click', () => {
      const text = log.map(entry => `[${entry.time}] ${entry.text}`).join('\n');
      navigator.clipboard.writeText(text)
        .then(() => alert('Laporan berhasil disalin!'))
        .catch(err => alert('Gagal menyalin: ' + err));
    });
    
    btnClear.addEventListener('click', () => {
      if (confirm('Apakah Anda yakin ingin menghapus semua laporan?')) {
        log = [];
        updateLog();
      }
    });

    // Auto stop scanner when page is closed
    window.addEventListener('beforeunload', stopScanner);
  </script>
</body>
</html>
